( [EN](./README.md) )
( [DE](./README-DE.md) )
---

Сервер представляет собой лёгкий обработчик текстовых скриптов с возможностью запуска шелл-процессов и вывода потока данных в браузер. Он может работать как отдельное приложение или как сервис.

### 1. Описание основной страницы и принцип взаимодействия скриптов

Основная страница может быть перенастроена для использования другого интерфейса, но здесь объясняется, как взаимодействуют скрипты между собой.  
Основная страница состоит из фиксированной панели с кнопкой меню и клиентской части, где отображаются результаты выполнения вызываемых скриптов.  
Клиентская часть реализована с использованием элемента `<iframe>`. Основная страница содержит несколько вспомогательных функций на JavaScript.  

При нажатии на кнопку меню функция `loadMenu()` отправляет асинхронный AJAX-запрос на сервер. Получив ответ, она строит дерево элементов меню и отображает его пользователю.  

При выборе элемента меню JavaScript изменяет свойство `src` элемента `contentFrame` (iFrame) на значение, соответствующее выбранному элементу меню. Таким образом, содержимое нового запроса отображается внутри фрейма.  

Ещё одна вспомогательная функция — `requestServer(URL)`. Она выполняет асинхронный запрос к серверу и возвращает результат. С её помощью можно добавлять новые переменные на сервер, изменять элементы меню и выполнять другие действия.  

#### 1.1. Внутренние URL сервера

##### 1.1.1. `/shell`
Запускает команду, переданную в параметре `cmd`. Реализовано в файле `shell.thtml`.  
Пример: `/shell?cmd=python myscript.py`  

##### 1.1.2. `/menulist`
Возвращает список элементов меню и их команд. По умолчанию они считываются из конфигурационного файла, но могут быть изменены с помощью запроса `/menu`, отправленного асинхронно функцией `requestServer()`.  

##### 1.1.3. `/menu`
Позволяет управлять меню:  
- `/menu?clear` — очищает список;  
- `/menu?default` — восстанавливает список из конфигурационного файла;  
- `/menu?captionX=My caption in menu X&cmdX=my URL` — изменяет или добавляет элемент меню с указанным заголовком и URL.  
Все команды можно комбинировать в одном запросе. Они выполняются в порядке, указанном в URL.  

##### 1.1.4. `/envvar`
Добавляет новую переменную и её значение для использования в шаблонах.  
Пример: `/envvar?myvar=My value` — переменная может быть вызвана в шаблоне как `$(myvar)`.  

##### 1.1.5. `/stop`
Останавливает прослушивание порта и завершает работу приложения.  

##### 1.1.6. `/shellresponse`
Возвращает все непрочитанные данные из потока вывода после выполнения команды через `/shell`. Если команда не выполняется, возвращается код ошибки 404.  

##### 1.1.7. `/shellrun`
Возвращает код 200, если команда была запущена через `/shell`. В противном случае возвращает код 404.  

### 2. Описание конфигурационного файла

#### 2.1. Секция `Application`

##### 2.1.1. Параметр `Port`
Указывает порт, на котором сервер будет прослушивать запросы. По умолчанию — 8080. При изменении порта необходимо настроить доступ через брандмауэр. Например, с помощью утилиты `ufw`:  
```bash
sudo ufw allow 8080/tcp
```

##### 2.1.2. Параметр `RootPath`
Содержит путь к каталогу с шаблонами запрашиваемых страниц. По умолчанию — `/var/techtool/thtml/`, но для отладки можно использовать любой другой.  

##### 2.1.3. Параметр `RootFileName`
Указывает имя файла шаблона, который будет использоваться при вызове URL `/`.  

##### 2.1.4. Параметр `WorkDir`
Содержит путь к папке для временных файлов, например логов. По умолчанию — `/tmp`.  

#### 2.2. Секция `MENU[X]`
Номер в названии секции обязателен и не должен повторяться.  

##### 2.2.1. Параметр `MenuCaption`
Содержит текст, отображаемый пользователю в меню.  

##### 2.2.2. Параметр `MenuCommand`
Содержит URL вызываемой страницы (см. описание URL).  

### 3. Обработка URL

При указании имени скрипта с расширением или без него производится поиск файла по пути, указанному в конфигурационном файле (`APPLICATION.RootPath`). Если файл не найден, браузер получает ответ с кодом 404.  

При запросе страницы сервер выполняет поиск и подстановку значений:  

#### 3.1. Конфигурационных переменных
В скрипте необходимо указать имя секции и параметра (без разделителя) в верхнем регистре.  
Например: `$(APPLICATIONPORT)`  

#### 3.2. Переменных окружения
В скрипте необходимо указать имя переменной с учётом регистра.  
Например: `$(SHELL)`  

#### 3.3. Переменных, заданных разработчиком при вызове шелла
Условия такие же, как и для переменных окружения.  

### 4. Отладка скриптов совместно с CSWS

В этом каталоге находятся три предварительно скомпилированные версии программы, предназначенные для разных платформ:

- **`aarch64-linux`** — версия для устройств на базе Raspberry Pi;
- **`x86_64-win64`** — версия для 64-битных систем Windows;
- **`x86_64-linux`** — версия для 64-битных систем Linux.

Запуск приложения с отдельным конфигурационным файлом позволяет гибко настраивать параметры и шаблоны, что упрощает отладку скриптов. Это дает возможность проверять их работу непосредственно в браузере без необходимости внесения изменений на устройстве Raspberry Pi.

#### 4.1. Параметры командной строки

Программа поддерживает следующие параметры командной строки:

- **`--conf="my.conf"`**  
  Запуск программы с использованием указанного конфигурационного файла. Это позволяет использовать индивидуальные настройки и шаблоны.

- **`--stop`**  
  Останавливает работу программы, если она уже запущена.

- **`--envvar`**  
  Выводит список всех переменных окружения, доступных для программы.

- **`--addmenu="<menu caption>:=:<command>"`**  
  Добавляет новую секцию меню в конфигурационный файл.  
  - `<menu caption>` — заголовок меню;  
  - `<command>` — команда, связанная с этим пунктом меню.

